name: Generate Structured Report From Commit

on:
  push:
    branches: [main]
    paths:
      - "scratch/**"

permissions:
  contents: write

jobs:
  generate:
    # avoid loop when bot commits generated report
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    environment: report-gen
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Detect changed scratch files
        id: changed
        run: |
          # --diff-filter=AMR: Added, Modified, Renamed; ignore deletions
          CHANGED="$(git diff --diff-filter=AMR --name-only "${{ github.event.before }}" "${{ github.sha }}" | grep '^scratch/' || true)"
          echo "changed<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGED" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Generate reports
        if: steps.changed.outputs.changed != ''
        env:
          REPORT_API_URL: ${{ vars.REPORT_API_URL }}
          REPORT_API_MODEL: ${{ vars.REPORT_API_MODEL }}
          REPORT_API_AUTH_HEADER: ${{ vars.REPORT_API_AUTH_HEADER }}
          REPORT_API_AUTH_SCHEME: ${{ vars.REPORT_API_AUTH_SCHEME }}
          REPORT_API_TIMEOUT: ${{ vars.REPORT_API_TIMEOUT }}
          REPORT_API_RESPONSE_PATH: ${{ vars.REPORT_API_RESPONSE_PATH }}
          REPORT_API_RESPONSE_PATHS: ${{ vars.REPORT_API_RESPONSE_PATHS }}
          REPORT_API_EXTRA_HEADERS_JSON: ${{ vars.REPORT_API_EXTRA_HEADERS_JSON }}
          REPORT_API_REQUEST_TEMPLATE_JSON: ${{ vars.REPORT_API_REQUEST_TEMPLATE_JSON }}
          REPORT_SYSTEM_PROMPT: ${{ vars.REPORT_SYSTEM_PROMPT }}
          REPORT_API_KEY: ${{ secrets.REPORT_API_KEY }}
          SHA: ${{ github.sha }}
        id: generate_step
        run: |
          set +e
          DATE_UTC="$(date -u +%F)"
          YEAR="$(date -u +%Y)"
          MONTH="$(date -u +%m)"
          HASH_INDEX="content/daily/${YEAR}/${MONTH}/.report_hashes.json"
          declare -A KNOWN_HASHES

          if [ -f "$HASH_INDEX" ]; then
            while IFS= read -r line; do
              h="${line//[\" ,]/}"
              [ -n "$h" ] && KNOWN_HASHES["$h"]=1
            done < "$HASH_INDEX"
          fi
          
          OVERALL_STATUS=0
          GENERATED_SLUGS=""
          
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            echo "Processing $file..."
            
            stem="$(basename "$file")"
            stem="${stem%.*}"
            slug="$(echo "$stem" | tr ' ' '-' | tr -cd '[:alnum:]_-')"
            outdir="content/daily/${YEAR}/${MONTH}"
            mkdir -p "$outdir"
            
            # Construct output path with date prefix
            out="${outdir}/${DATE_UTC}-${slug}.md"
            
            # Skip if hash already exists in index
            file_hash="$(python -c "import sys; sys.path.append('scripts'); from generate_report import compute_hash_bytes; p=sys.argv[1]; data=open(p,'rb').read(); print(compute_hash_bytes(data))" "$file")"

            if [ -n "${KNOWN_HASHES[$file_hash]+x}" ]; then
              echo "Skipping $file (hash already generated)."
              continue
            fi

            OUTPUT=$(python scripts/generate_report.py \
              --input "$file" \
              --output "$out" \
              --source-type commit \
              --source-id "$SHA" \
              --date "$DATE_UTC")
            
            code=$?
            echo "$OUTPUT"
            
            if [ $code -eq 1 ]; then
               echo "::error::Failed to generate report for $file"
               exit 1
            elif [ $code -eq 2 ]; then
               echo "::warning::Report for $file needs review."
               OVERALL_STATUS=2
            fi
            
            report_path="$(echo "$OUTPUT" | grep "^REPORT_PATH=" | cut -d'=' -f2 || echo "")"
            if [ -n "$report_path" ]; then
              echo "Generated $report_path"
              slug_name="$(basename "$report_path" | sed -E 's/^[0-9]{4}-[0-9]{2}-[0-9]{2}-//' | sed -E 's/\.md$//')"
            else
              echo "Generated $out"
              slug_name=""
            fi
            if [ -n "$slug_name" ]; then
              if [ -n "$GENERATED_SLUGS" ]; then
                GENERATED_SLUGS="$GENERATED_SLUGS,$slug_name"
              else
                GENERATED_SLUGS="$slug_name"
              fi
            fi
          done <<< "${{ steps.changed.outputs.changed }}"
          
          echo "overall_status=$OVERALL_STATUS" >> "$GITHUB_OUTPUT"
          echo "generated_slugs=$GENERATED_SLUGS" >> "$GITHUB_OUTPUT"

      - name: Commit generated reports (Direct)
        if: steps.generate_step.outputs.overall_status == '0'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add content/daily/ || true
          if git diff --cached --quiet; then
            echo "No generated changes."
            exit 0
          fi
          SLUGS="${{ steps.generate_step.outputs.generated_slugs }}"
          if [ -n "$SLUGS" ]; then
            git commit -m "auto: generate reports [slugs: $SLUGS] [skip ci]"
          else
            git commit -m "auto: generate reports [skip ci]"
          fi
          git push

      - name: Create PR for Review (Quality Gate)
        if: steps.generate_step.outputs.overall_status == '2'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          BRANCH_NAME="review/commit-${{ github.sha }}-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          
          git add content/daily/
          SLUGS="${{ steps.generate_step.outputs.generated_slugs }}"
          if [ -n "$SLUGS" ]; then
            git commit -m "chore: reports need review [slugs: $SLUGS]"
          else
            git commit -m "chore: reports need review"
          fi
          git push origin "$BRANCH_NAME"
          
          gh label create needs-review --force || true
          gh pr create \
            --title "⚠️ Review Needed: Reports from Commit ${{ github.sha }}" \
            --body "One or more generated reports failed standardization checks. Please review the changes." \
            --label "needs-review" \
            --base main \
            --head "$BRANCH_NAME"

      - name: Comment on Commit (Failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.sha
            const runId = context.runId
            
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha,
              body: `❌ Report generation failed. Please check the [Actions Log](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}).`
            })
