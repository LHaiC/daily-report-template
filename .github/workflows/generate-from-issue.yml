name: Generate Structured Report From Issue

on:
  issues:
    types: [opened, edited, reopened, labeled]

permissions:
  contents: write
  issues: write

jobs:
  generate:
    if: |
      contains(github.event.issue.labels.*.name, 'raw-note') ||
      startsWith(github.event.issue.title, '[RAW]')
    runs-on: ubuntu-latest
    environment: report-gen
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build scratch file from issue body
        id: issuefile
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          python - <<'PY'
          import os, pathlib, datetime
          num = os.environ["ISSUE_NUMBER"]
          title = os.environ.get("ISSUE_TITLE","")
          body = os.environ.get("ISSUE_BODY","") or ""
          p = pathlib.Path("scratch") / f"issue-{num}.md"
          p.parent.mkdir(parents=True, exist_ok=True)
          p.write_text(f"# {title}\n\n{body}\n", encoding="utf-8")
          print(f"wrote {p}")
          now = datetime.datetime.utcnow()
          report_dir = pathlib.Path("content/daily") / now.strftime("%Y") / now.strftime("%m")
          report_dir.mkdir(parents=True, exist_ok=True)
          report_path = report_dir / f"{now.strftime('%Y-%m-%d')}-issue-{num}.md"
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              f.write(f"scratch_path={p}\n")
              f.write(f"report_path={report_path}\n")
          PY

      - name: Generate report from issue
        env:
          REPORT_API_URL: ${{ vars.REPORT_API_URL }}
          REPORT_API_MODEL: ${{ vars.REPORT_API_MODEL }}
          REPORT_API_AUTH_HEADER: ${{ vars.REPORT_API_AUTH_HEADER }}
          REPORT_API_AUTH_SCHEME: ${{ vars.REPORT_API_AUTH_SCHEME }}
          REPORT_API_TIMEOUT: ${{ vars.REPORT_API_TIMEOUT }}
          REPORT_API_RESPONSE_PATH: ${{ vars.REPORT_API_RESPONSE_PATH }}
          REPORT_API_RESPONSE_PATHS: ${{ vars.REPORT_API_RESPONSE_PATHS }}
          REPORT_API_EXTRA_HEADERS_JSON: ${{ vars.REPORT_API_EXTRA_HEADERS_JSON }}
          REPORT_API_REQUEST_TEMPLATE_JSON: ${{ vars.REPORT_API_REQUEST_TEMPLATE_JSON }}
          REPORT_SYSTEM_PROMPT: ${{ vars.REPORT_SYSTEM_PROMPT }}
          REPORT_API_KEY: ${{ secrets.REPORT_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        id: generate_step
        run: |
          set +e
          # Capture output to find the actual file path written
          OUTPUT=$(python scripts/generate_report.py \
            --input "${{ steps.issuefile.outputs.scratch_path }}" \
            --output "${{ steps.issuefile.outputs.report_path }}" \
            --source-type issue \
            --source-id "${ISSUE_NUMBER}" \
            --date "$(date +%Y-%m-%d)")
          
          exit_code=$?
          echo "$OUTPUT" # Print to log for debugging
          
          # Extract REPORT_PATH from output
          # Look for line starting with REPORT_PATH=
          REAL_REPORT_PATH=$(echo "$OUTPUT" | grep "^REPORT_PATH=" | cut -d'=' -f2 || echo "${{ steps.issuefile.outputs.report_path }}")
          SLUG_NAME="$(basename "$REAL_REPORT_PATH" | sed -E 's/^[0-9]{4}-[0-9]{2}-[0-9]{2}-//' | sed -E 's/\.md$//')"
          
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          echo "report_path=$REAL_REPORT_PATH" >> $GITHUB_OUTPUT
          echo "slug_name=$SLUG_NAME" >> $GITHUB_OUTPUT
          
          if [ $exit_code -eq 1 ]; then
            echo "::error::Report generation failed with fatal error."
            exit 1
          fi
          
          if [ $exit_code -eq 2 ]; then
            echo "::warning::Report generated but needs review (standardization failed)."
          fi

      - name: Commit generated report (Direct)
        if: steps.generate_step.outputs.exit_code == '0'
        id: commit
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Check for changes using the dynamic path
          git add "${{ steps.issuefile.outputs.scratch_path }}" content/daily/ || true
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes to commit."
            exit 0
          fi
          
          SLUG_NAME="${{ steps.generate_step.outputs.slug_name }}"
          if [ -n "$SLUG_NAME" ]; then
            git commit -m "auto: generate report for issue #${{ github.event.issue.number }} [slug: $SLUG_NAME] [skip ci]"
          else
            git commit -m "auto: generate report for issue #${{ github.event.issue.number }} [skip ci]"
          fi
          git push
          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Create PR for Review (Quality Gate)
        if: steps.generate_step.outputs.exit_code == '2'
        id: pr_creation
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          BRANCH_NAME="review/issue-${{ github.event.issue.number }}-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          
          git add "${{ steps.issuefile.outputs.scratch_path }}" content/daily/ || true
          SLUG_NAME="${{ steps.generate_step.outputs.slug_name }}"
          if [ -n "$SLUG_NAME" ]; then
            git commit -m "chore: report needs review (issue #${{ github.event.issue.number }}) [slug: $SLUG_NAME]"
          else
            git commit -m "chore: report needs review (issue #${{ github.event.issue.number }})"
          fi
          git push origin "$BRANCH_NAME"
          
          gh label create needs-review --force || true
          gh pr create \
            --title "⚠️ Review Needed: Report for Issue #${{ github.event.issue.number }}" \
            --body "The generated report failed standardization checks. Please review and merge manually." \
            --label "needs-review" \
            --base main \
            --head "$BRANCH_NAME"

      - name: Comment on Issue (Success)
        if: steps.commit.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number
            const path = "${{ steps.generate_step.outputs.report_path }}"
            const sha = context.sha
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `✅ Generated structured report:\n\n- \`${path}\`\n- Commit: ${sha}`
            })
            
            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: "closed"
            })

      - name: Comment on Issue (Failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number
            const runId = context.runId
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `❌ Report generation failed. Please check the [Actions Log](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}).`
            })
